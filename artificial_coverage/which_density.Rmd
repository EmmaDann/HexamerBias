---
title: "R Notebook"
output: html_notebook
---
```{r message = FALSE, warning=FALSE}
library(dplyr)
library(ggplot2)
library(ggrepel)
library(reshape2)
library(rtracklayer)
source('~/HexamerBias/artificial_coverage/compare_peaks.r')
```

#### DENSITY FOR TARGETED SEQUENCING
Suppose we want to capture CTCF sites.
```{bash}
cat ../annotations_bed/CTCF_intestine_mm10.srt.bed |    
bedtools flank -i stdin -g ../../genomes/mm10/mm10.genome -b 500 | 
cut -f 1,2,3,4 |  
bedtools groupby -g 1,4 -c 2,3 -o min,max | 
awk '{print $1, $3, $4}' | 
tr ' ' '\t' > CTCF.flank.bed

bedtools getfasta -fi /hpc/hub_oudenaarden/edann/genomes/mm10/mm10.fa -bed CTCF.flank.bed -fo CTCF.flank.fa
```

I assume that having a probability density proportional to the kmer abundance in the region of interest would boost coverage in that particular region. But is this true?

1. Counting kmers in the regions flanking CTCF sites 
```{bash}
/hpc/hub_oudenaarden/edann/bin/coverage_bias/kmerCounter.py CTCF.flank.fa > CTCF.flank.kmers.txt
tail -n+2 CTCF.flank.kmers.txt > CTCF.flank.kmers.tab
cat CTCF.flank.kmers.tab | tail -n+2 | tr '\t' ','> CTCF.flank.kmers.csv
```

2. Correlating with total kmer abundance in the genome
```{r}
CTCF.kmers <- read.table('~/mnt/edann/hexamers/strand_specific/CTCF.flank.kmers.tab', header = TRUE, col.names = c('abundance.ctcf', 'kmer'))
mm10.kmers <- read.csv(gzfile('~/mnt/edann/hexamers/VAN1667prediction/mm10.cellAbundance.noN.csv.gz'), header=FALSE, col.names = c('kmer','abundance.tot'))
head(mm10.kmers)
head(CTCF.kmers)
abtab <- merge(CTCF.kmers, mm10.kmers, by='kmer')
abtab <- abtab %>% 
  mutate(frac.ctcf = abundance.ctcf/sum(abundance.ctcf)*100, 
         frac.tot = abundance.tot/sum(as.numeric(abundance.tot))*100) %>%
  mutate(ratio.ctcf.tot = frac.ctcf/frac.tot) %>% 
  arrange(-ratio.ctcf.tot)
head(abtab)                  
```
G and C rich sequences are overreppresented compared to the total genome abundance.
```{r}
abtab$kmer <- factor(abtab$kmer, levels=abtab$kmer)  
abtab[1:50,] %>%
  ggplot(., aes(x=kmer,y=ratio.ctcf.tot, label=kmer)) + 
  geom_bar(stat = 'identity') +
  coord_flip()
  # geom_text(cex=2, nudge_y = 1000)
```
3. Compute coverage for density proportional to the kmer abundance in the flanks of CTCF sites, with function ```coverage_prop_to_kmer_abundance``` in module ```optimization/primerProbability```

4. Compute predicted coverage profile with computed binding events
```
echo "source /hpc/hub_oudenaarden/edann/venv2/bin/activate; python /hpc/hub_oudenaarden/edann/bin/coverage_bias/artificial_coverage/strand_specific_artificial_coverage.py /hpc/hub_oudenaarden/edann/hexamers/VAN1667prediction/mm10.cellAbundance.noN.csv.gz CTCF.flank.propCov.csv artificial_coverage/highcov.random.42.bed /hpc/hub_oudenaarden/edann/genomes/mm10/mm10.fa -t 10" | qsub -cwd -N artcov_CTCF -pe threaded 10 -l h_rt=24:00:00 -l h_vmem=80G -l h_cpu=10:00:00
```
I did a test with 5 regions in chromosome 1
```{r}
norm.bw.file <- '~/mnt/edann/hexamers/strand_specific/artificial_coverage/highcov.random.42.artCov.bw'
ctcf.bw.file <- '~/mnt/edann/hexamers/strand_specific/artificial_coverage/CTCF_flank.highcov.random.42.test.artCov.bw'

ctcf.bw <- import(ctcf.bw.file, format = 'BigWig')
ranges <- GRanges(seqnames = ctcf.bw@seqnames, 
                  ranges = IRanges(start=ctcf.bw@ranges@start, 
                                   end = ctcf.bw@ranges@start+1))
norm.bw <- import(norm.bw.file, format = 'BigWig', which = ranges)
```


```{r}
predcov.bw <- make.predVSexp.range(ctcf.bw, norm.bw)
colnames(values(predcov.bw)) <- c('ctcf','norm')
predcov.bw <- add.id(predcov.bw)
l.predcov.bw <- split(predcov.bw, predcov.bw$id)
```

```{r}
plot.expVSpred.coverage.track(l.predcov.bw[[3]])
plot.expVSpred.coverage.track(l.predcov.bw[[6]])
```
Well things seem to change a lot!
Where are the CTCF sites?
```{r}
ctcf.bed <- '~/mnt/edann/hexamers/annotations_bed/CTCF_intestine_mm10.srt.bed'
ctcf<- import(ctcf.bed, format = 'bed')
cov.track <- plot.expVSpred.coverage.track(l.predcov.bw[[6]], plot = FALSE)
ctcf
ctcf.track <- DataTrack(ctcf,
                        chromosome=chrom)
```
## Real artificial coverage 
```{r}
ctcf.bw.file <- '~/mnt/edann/hexamers/strand_specific/artificial_coverage/highcov.random.42CTCF.flank.propCov.artCov.bw'

ctcf.bw <- import(ctcf.bw.file, format = 'BigWig')
ranges <- GRanges(seqnames = ctcf.bw@seqnames, 
                  ranges = IRanges(start=ctcf.bw@ranges@start, 
                                   end = ctcf.bw@ranges@start+1))
norm.bw <- import(norm.bw.file, format = 'BigWig', which = ranges)
```

```{r}
predcov.bw <- make.predVSexp.range(ctcf.bw, norm.bw)
colnames(values(predcov.bw)) <- c('ctcf','norm')
predcov.bw <- add.id(predcov.bw)
l.predcov.bw <- split(predcov.bw, predcov.bw$id)
predcov.bw
```
```{r}
plot.expVSpred.coverage.track(normalize.coverage(l.predcov.bw[[2]]))
```
```{r}
ctcf.ovs <- findOverlaps(predcov.bw,ctcf)
ctcf.cov <- predcov.bw[queryHits(ctcf.ovs)]
regionsWctcf <- ctcf.cov$id
```
```{r}
test.bw <- l.predcov.bw[sample(regionsWctcf,1)][[1]]
lapply(sample(regionsWctcf,10), function(x) plot.cov.wAnnotation(l.predcov.bw[x][[1]], ctcf))
```
Is the difference in predicted coverage around CTCF sites significant using the density proportional to the kmer abundance around CTCF sites?
```{r}
ctcf.cov <- predcov.bw[queryHits(ctcf.ovs)]
t.test(ctcf.cov$ctcf, ctcf.cov$norm)
as.data.frame(values(ctcf.cov)) %>% 
  rename(prop.CTCF.kmers=ctcf,
         normal=norm) %>%
  melt(id.vars='id', value.name='predicted.cov', variable.name='density') %>%
# pval.df <- compare_means(mean.cov ~ spear.group, data=cov.cor.clean, method='t.test') %>%
#   mutate(y.pos=6e-07)
ggplot(., aes(density,predicted.cov)) +
  geom_boxplot() +
  theme_classic() +
  theme(axis.title = element_text(size = 20), axis.text = element_text(size=14), title = element_text(size=22))
```
Is it significantly higher than the real coverage I get with equal amounts of primers?
```{r}
exp.bw.file <- '~/mnt/edann/hexamers/strand_specific/VAN1667_se.highcov42.bedGraph'
exp.bw <- import(exp.bw.file, format = 'bedGraph', which = ranges)
exp.bw.base <- make.base.res.bw(exp.bw)
ctcfreal.bw <- make.predVSexp.range(exp.bw = ctcf.bw, pred.bw = exp.bw.base)
colnames(mcols(ctcfreal.bw)) <- c('CTCF.cov','real.cov')
ctcfreal.bw  <- add.id(ctcfreal.bw )
ctcfreal.bw
```
```{r}
real.ovs <- findOverlaps(ctcfreal.bw, ctcf)
real.cov <- normalize.coverage(ctcfreal.bw[queryHits(real.ovs)])
t.test(real.cov$real.cov, ctcf.cov$norm, alternative = 'less')

as.data.frame(values(real.cov)) %>% 
  # rename(prop.CTCF.kmers=ctcf,
         # normal=norm) %>%
  melt(id.vars='id', value.name='predicted.cov', variable.name='density') %>%
# pval.df <- compare_means(mean.cov ~ spear.group, data=cov.cor.clean, method='t.test') %>%
#   mutate(y.pos=6e-07)
ggplot(., aes(density,predicted.cov)) +
  geom_boxplot() +
  theme_classic() +
  theme(axis.title = element_text(size = 20), axis.text = element_text(size=14), title = element_text(size=22))
```
Fair enough.

# Questions:
* How to reduce off target effects?
* 

