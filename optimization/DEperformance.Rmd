---
title: "DE performance"
output: html_notebook
---
```{r message = FALSE, warning=FALSE}
library(dplyr)
library(ggplot2)
library(ggrepel)
library(reshape2)
library(rtracklayer)
library(shiny)
source('~/HexamerBias/artificial_coverage/compare_peaks.r')
```
## Performance of test function
Searches for the matrix with the higher probability of having a CGCGCG primer (only one solution). Minimizes 1-p(CGCGCG)
```{r}
test.perf <- read.csv('~/mnt/edann/hexamers/strand_specific/test_function.performance.csv', header = FALSE, col.names = c('it','score'))
head(test.perf)
```

```{r}
ggplot(test.perf, aes(it,score)) +
  geom_line()
```

### Test of real function
Functions for reshaping and plotting are in DE_performance.r
```{r}
opt.dir <- '~/mnt/edann/hexamers/DEoptimization/even_cov/'
matrix.files <- list.files(opt.dir, pattern = 'matrix.csv', full.names = TRUE)
performance.mat <- read.csv(matrix.files[1], row.names = 1)
head(performance.mat)
```

```{r}
long.mat <- reshape.prob.mat(performance.mat)
head(long.mat)
max(long.mat$iter)
```

```{r}
l <- lapply(seq(1,3), function(i) plot.iteration(long.mat, i))
# png('~/AvOwork/output/DE_optimization/test_iter_matrix.png')
for(el in l){
  # png(paste0("~/AvOwork/output/DE_optimization/DE_iter-", el$data$iter[1], ".png"))
  plot(el)
  # dev.off()
}
```

### MIN RHO OF DIFFERENT TESTS

With bigger population size I get better scores and if the algorithm gets stuck in a local minimum it happens after more iterations.
```{r}
rho.files.10 <- list.files(opt.dir, pattern='_pop10_its300.DE.rho.txt', full.names = TRUE)
rho.files.20 <- list.files(opt.dir, pattern='_pop20_its300.DE.rho.txt', full.names = TRUE)
rho.files.30 <- list.files(opt.dir, pattern='_pop30_its300.DE.rho.txt', full.names = TRUE)

plot.optimization.score(rho.files.10) +
  ggtitle('Pop.size=10')

plot.optimization.score(rho.files.20) +
  ggtitle('Pop.size=20')

plot.optimization.score(rho.files.30) +
  ggtitle('Pop.size=30')

```
## Test on new optimization: maximizing density in region of interest
```{r}
opt.dir <- '~/mnt/edann/hexamers/DEoptimization/ctcf_cov/'
matrix.files <- list.files(opt.dir, pattern = '.+minimize.+matrix.csv', full.names = TRUE)
performance.mat <- read.csv("~/mnt/edann/hexamers/DEoptimization/even_cov/test1_ctcf.DE.matrix.csv", row.names = 1)
performance.mat
plot.iteration(reshape.prob.mat(performance.mat),1)
plot.iteration(reshape.prob.mat(performance.mat),99)

```
```{r}
score.ctcf.files <- list.files(opt.dir, pattern = '.+ctcf.+rho.txt', full.names = TRUE)
plot.optimization.score(score.ctcf.files) 
```
```{r}
matrix.ctcf.files <- list.files(opt.dir, pattern = '.+ctcf.+matrix', full.names = TRUE)
matrix.ctcf.files
performance.mat <- read.csv(matrix.ctcf.files[4], row.names = 1)
long.mat <- reshape.prob.mat(performance.mat)
head(performance.mat)
nrow(performance.mat)
lapply(matrix.ctcf.files, function(mat) 
  plot.iteration(reshape.prob.mat(read.csv(mat, row.names = 1)),99) +
    ggtitle(gsub(mat, pattern = '.+//', replacement = '')))
```

Test4 is so weird! Best score and ends with all Ts!!
```{r}
performance.mat <- read.csv(matrix.ctcf.files[5], row.names = 1)
long.mat <- reshape.prob.mat(performance.mat)
lapply(c(1,10,20,50,70,99),function(it) plot.iteration(long.mat, it))
```

# What does the profile full of Ts look like?
```{r}
bestmat.bw.file <- '~/mnt/edann/hexamers/strand_specific/artificial_coverage/highcov.random.42test1_ctcf_bestMat.coverage.artCov.bw'
exp.bw.file <- '~/mnt/edann/hexamers/strand_specific/VAN1667_se.highcov42.bedGraph'

bestmat.bw <- import(bestmat.bw.file, format = 'BigWig')
ranges <- GRanges(seqnames = pred.bw@seqnames, 
                  ranges = IRanges(start=pred.bw@ranges@start, 
                                   end = pred.bw@ranges@start+1))
exp.bw <- import(exp.bw.file, format = 'bedGraph', which = ranges)
```
# Average coverage on CTCF sites
```{r}
bestmat.prof.norm <- load.profile('~/mnt/edann/hexamers/strand_specific/artificial_coverage/highcov.random.42CTCF.flank60.ratio.coverage.artCov.CTCF.profile.txt')
CTCF.pred.norm <- load.profile('~/mnt/edann/hexamers/strand_specific/artificial_coverage/highcov.random.42.artCov.CTCF.profile.txt')
CTCF.pred.prop <- load.profile('~/mnt/edann/hexamers/strand_specific/artificial_coverage/highcov.random.42CTCF.flank60.coverage.artCov.CTCF.profile.txt')

bestmat.df <- make.df.of.profiles(list(best.matrix=bestmat.prof.norm,
                                       prediction.even=CTCF.pred.norm,
                                       prediction.proportional=CTCF.pred.prop))
plot.refpoint.profile.df(bestmat.df)
                               
                              
```
## Optimizing density of enriched kmers
Not total abundance

1. Popsize = 20
```{r}
opt.dir <- '~/mnt/edann/hexamers/DEoptimization/ctcf_cov/'
score.ctcf.files <- list.files(opt.dir, pattern = '.+ctcf_kmersFC.+pop20.+rho.txt', full.names = TRUE)
plot.optimization.score(score.ctcf.files) +
  theme(legend.title = element_blank())
```
1. Popsize = 30
```{r}
opt.dir <- '~/mnt/edann/hexamers/DEoptimization/ctcf_cov/'
score.ctcf.files <- list.files(opt.dir, pattern = '.+ctcf_kmersFC.+pop30.+rho.txt', full.names = TRUE)
plot.optimization.score(score.ctcf.files) +
  theme(legend.title = element_blank())
```

